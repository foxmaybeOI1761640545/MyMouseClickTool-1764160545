# 输入控制器优化 - 更改说明

## 概述

本次更新对 `app/input_controller.py` 进行了重大改进，将键盘输入方式从使用 `pynput` 库的文本输入方法改为直接调用 Windows API 的按键模拟方式，以提高输入模拟的真实性和兼容性。

## 主要更改内容

### 1. 新增 Windows API 支持

#### 1.1 导入模块
- 新增 `ctypes` 和 `wintypes` 模块导入，用于调用 Windows API
- 从 `pynput.keyboard` 导入 `Key` 类，用于处理特殊按键

#### 1.2 Windows API 常量定义
- `INPUT_KEYBOARD = 1`: 标识键盘输入类型
- `KEYEVENTF_KEYUP = 0x0002`: 标识按键释放事件
- `VK_SPACE = 0x20`: 空格键虚拟键码
- `VK_RETURN = 0x0D`: 回车键虚拟键码
- `VK_TAB = 0x09`: Tab键虚拟键码

#### 1.3 Windows API 结构体定义
定义了以下结构体以匹配 Windows API 的输入结构：
- `KEYBDINPUT`: 键盘输入结构
- `MOUSEINPUT`: 鼠标输入结构（为未来扩展预留）
- `HARDWAREINPUT`: 硬件输入结构（为未来扩展预留）
- `INPUT_UNION`: 输入联合体
- `INPUT`: 输入结构体

#### 1.4 SendInput 函数绑定
- 绑定了 Windows API 的 `SendInput` 函数，用于发送键盘输入事件

### 2. 新增核心方法

#### 2.1 `_get_vk_code(char: str) -> int`
**功能**: 将字符转换为 Windows 虚拟键码

**支持的字符类型**:
- 字母键 A-Z (0x41-0x5A)
- 数字键 0-9 (0x30-0x39)
- 特殊字符：空格、换行符、Tab键

**实现逻辑**:
- 字母转换为大写后获取 ASCII 码
- 数字直接获取 ASCII 码
- 特殊字符通过映射表获取对应的虚拟键码

#### 2.2 `_send_key_input(vk_code: int, key_down: bool)`
**功能**: 使用 Windows API `SendInput` 发送按键事件

**参数**:
- `vk_code`: Windows 虚拟键码
- `key_down`: `True` 表示按下，`False` 表示释放

**实现**: 创建 `KEYBDINPUT` 结构，封装为 `INPUT` 结构，调用 `SendInput` API

#### 2.3 `_press_key(key)`
**功能**: 模拟按键按下和释放的完整过程

**特性**:
- 支持字符和 `Key` 对象两种输入类型
- 使用 Windows API 作为主要方法
- 包含按键保持时间（25毫秒），模拟真实按键行为
- 提供异常处理和后备方案：如果 Windows API 失败，自动回退到 `pynput` 方法

**按键流程**:
1. 按下按键（发送 KEYDOWN 事件）
2. 保持按键 25 毫秒
3. 释放按键（发送 KEYUP 事件）

#### 2.4 `_parse_key(char: str)`
**功能**: 解析字符为按键对象（保留用于兼容性）

**说明**: 目前直接返回字符本身，因为现在使用虚拟键码方式

### 3. 修改现有功能

#### 3.1 `__init__()` 方法
**新增属性**:
- `self.key_hold_time_ms = 25`: 按键保持时间（毫秒），用于模拟真实按键按下时间

#### 3.2 `_input_loop()` 方法
**关键更改**:
- **原实现**: 使用 `self.controller.type(char)` 进行文本输入
- **新实现**: 使用 `self._press_key(parsed_key)` 进行按键模拟

**优势**:
- 更接近真实按键行为（包含按下和释放事件）
- 更好的兼容性（某些应用程序可能无法正确接收文本输入事件）
- 更精确的控制（可以控制按键保持时间）

#### 3.3 字符串间隔默认值调整
- **原值**: `interval_ms` 默认值为 1000 毫秒
- **新值**: `interval_ms` 默认值为 100 毫秒

**影响**: 字符串之间的间隔时间缩短，提高输入速度

## 技术优势

### 1. 更高的兼容性
- 直接使用 Windows API，绕过高级库可能存在的兼容性问题
- 某些游戏或应用程序可能无法正确接收 `pynput` 的文本输入，但可以接收 Windows API 的按键事件

### 2. 更真实的模拟
- 包含完整的按键按下和释放过程
- 按键保持时间模拟真实用户行为
- 逐字符按键而非批量文本输入

### 3. 更好的容错性
- 实现了双重保障机制：Windows API 失败时自动回退到 `pynput`
- 异常处理确保程序不会因单个按键失败而崩溃

### 4. 可扩展性
- 预留了鼠标输入结构（`MOUSEINPUT`），为未来功能扩展做准备
- 虚拟键码映射可以轻松扩展支持更多特殊字符

## 代码质量改进

1. **类型安全**: 使用 `wintypes` 确保数据类型与 Windows API 匹配
2. **结构清晰**: 将 Windows API 相关代码集中管理
3. **文档完善**: 所有新增方法都包含详细的文档字符串
4. **向后兼容**: 保留 `_parse_key` 方法，确保接口兼容性

## 潜在影响

### 正面影响
- 提高输入模拟的成功率
- 改善在某些应用程序中的兼容性
- 更接近真实用户输入行为

### 注意事项
- 需要 Windows 操作系统（使用了 Windows 特定 API）
- 按键保持时间固定为 25 毫秒，如需调整可修改 `key_hold_time_ms` 属性
- 字符串间隔默认值已缩短，如需更长间隔需要在配置中明确指定

## 测试建议

建议在以下场景中测试新实现：
1. 游戏内文本输入
2. 各种文本编辑器
3. 命令行界面
4. 网页表单输入
5. 特殊字符输入（空格、回车、Tab等）

## 总结

本次更新通过引入 Windows API 直接调用，显著提升了键盘输入模拟的真实性和兼容性。同时保持了良好的代码结构和错误处理机制，确保在各种环境下都能稳定运行。
